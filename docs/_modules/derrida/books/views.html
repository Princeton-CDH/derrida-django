
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>derrida.books.views &#8212; Derrida 1.2.2 documentation</title>
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for derrida.books.views</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="kn">from</span> <span class="nn">dal</span> <span class="k">import</span> <span class="n">autocomplete</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="k">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="k">import</span> <span class="n">permission_required</span>
<span class="kn">from</span> <span class="nn">django.core.cache</span> <span class="k">import</span> <span class="n">cache</span>
<span class="kn">from</span> <span class="nn">django.db.models</span> <span class="k">import</span> <span class="n">Max</span><span class="p">,</span> <span class="n">Min</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponse</span><span class="p">,</span> <span class="n">Http404</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="k">import</span> <span class="n">get_object_or_404</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="k">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="k">import</span> <span class="n">method_decorator</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="k">import</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">ListView</span><span class="p">,</span> <span class="n">View</span>
<span class="kn">from</span> <span class="nn">django.views.generic.base</span> <span class="k">import</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">django.views.generic.edit</span> <span class="k">import</span> <span class="n">FormView</span>
<span class="kn">from</span> <span class="nn">djiffy.models</span> <span class="k">import</span> <span class="n">Canvas</span><span class="p">,</span> <span class="n">get_iiif_url</span>
<span class="kn">from</span> <span class="nn">haystack.query</span> <span class="k">import</span> <span class="n">SearchQuerySet</span>
<span class="kn">from</span> <span class="nn">haystack.inputs</span> <span class="k">import</span> <span class="n">Clean</span><span class="p">,</span> <span class="n">Raw</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">derrida.books.forms</span> <span class="k">import</span> <span class="n">ReferenceSearchForm</span><span class="p">,</span> <span class="n">InstanceSearchForm</span><span class="p">,</span> \
    <span class="n">SearchForm</span><span class="p">,</span> <span class="n">SuppressImageForm</span>
<span class="kn">from</span> <span class="nn">derrida.books.models</span> <span class="k">import</span> <span class="n">Publisher</span><span class="p">,</span> <span class="n">Language</span><span class="p">,</span> <span class="n">Instance</span><span class="p">,</span> <span class="n">Reference</span><span class="p">,</span> \
    <span class="n">DerridaWork</span><span class="p">,</span> <span class="n">DerridaWorkSection</span>
<span class="kn">from</span> <span class="nn">derrida.common.utils</span> <span class="k">import</span> <span class="n">absolutize_url</span>
<span class="kn">from</span> <span class="nn">derrida.common.solr_backend</span> <span class="k">import</span> <span class="n">facet_sort_ignoreaccents</span>
<span class="kn">from</span> <span class="nn">derrida.interventions.models</span> <span class="k">import</span> <span class="n">Intervention</span>
<span class="kn">from</span> <span class="nn">derrida.outwork.models</span> <span class="k">import</span> <span class="n">Outwork</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<div class="viewcode-block" id="PublisherAutocomplete"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.PublisherAutocomplete">[docs]</a><span class="k">class</span> <span class="nc">PublisherAutocomplete</span><span class="p">(</span><span class="n">autocomplete</span><span class="o">.</span><span class="n">Select2QuerySetView</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Basic publisher autocomplete lookup, for use with</span>
<span class="sd">    django-autocomplete-light.  Restricted to staff only.&#39;&#39;&#39;</span>
    <span class="c1"># NOTE staff restriction applied in url config</span>

<div class="viewcode-block" id="PublisherAutocomplete.get_queryset"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.PublisherAutocomplete.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div></div>
        <span class="k">return</span> <span class="n">Publisher</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__icontains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>


<div class="viewcode-block" id="LanguageAutocomplete"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.LanguageAutocomplete">[docs]</a><span class="k">class</span> <span class="nc">LanguageAutocomplete</span><span class="p">(</span><span class="n">autocomplete</span><span class="o">.</span><span class="n">Select2QuerySetView</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Autocomplete lookup for :class:`derrida.books.models.Language`, for use with</span>
<span class="sd">    django-autocomplete-light.  Restricted to staff only.&#39;&#39;&#39;</span>
    <span class="c1"># NOTE staff restriction applied in url config</span>

<div class="viewcode-block" id="LanguageAutocomplete.get_queryset"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.LanguageAutocomplete.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div></div>
        <span class="k">return</span> <span class="n">Language</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">name__icontains</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">)</span>


<div class="viewcode-block" id="InstanceDetailView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceDetailView">[docs]</a><span class="k">class</span> <span class="nc">InstanceDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;:class:`~django.views.generic.DetailView` for</span>
<span class="sd">    :class:`~derrida.books.models.Instance`. Returns only Instances that have</span>
<span class="sd">    digital editions set.&#39;&#39;&#39;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Instance</span>
    <span class="n">slug_field</span> <span class="o">=</span> <span class="s1">&#39;slug&#39;</span>

<div class="viewcode-block" id="InstanceDetailView.get_queryset"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceDetailView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">InstanceDetailView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span></div></div>
        <span class="k">return</span> <span class="n">instances</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">digital_edition__isnull</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<div class="viewcode-block" id="InstanceURIView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceURIView">[docs]</a><span class="k">class</span> <span class="nc">InstanceURIView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generic view for Instance by URI identifier.  Redirects</span>
<span class="sd">    to the best view for that item.&#39;&#39;&#39;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Instance</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># if this instance is a book with a digital edition, redirect</span>
        <span class="c1"># to the book detail view</span>

        <span class="c1"># NOTE: not sure why get_object isn&#39;t called automatically</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
        <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">search_slug</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">digital_edition</span><span class="p">:</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span>
            <span class="c1"># 1-for-1 relationship, this is not a see other redirect</span>
            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># if this is a section of a book with a digital edition,</span>
        <span class="c1"># redirect to book detail view, and jump to book section anchor</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">collected_in</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">collected_in</span><span class="o">.</span><span class="n">digital_edition</span><span class="p">:</span>
            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">#sections&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">collected_in</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">())</span>

        <span class="c1"># if this is a book, link to a library search for this item</span>
        <span class="c1"># (or book section)</span>

        <span class="k">if</span> <span class="n">redirect_url</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="s1">&#39;Book&#39;</span><span class="p">:</span>
                <span class="n">search_slug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">slug</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">item_type</span> <span class="o">==</span> <span class="s1">&#39;Book Section&#39;</span><span class="p">:</span>
                <span class="n">search_slug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">collected_in</span><span class="o">.</span><span class="n">slug</span>

            <span class="k">if</span> <span class="n">search_slug</span><span class="p">:</span>
                <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">?query=</span><span class="si">{}</span><span class="s1">&amp;is_extant=false&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;books:list&#39;</span><span class="p">),</span> <span class="n">search_slug</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">redirect_url</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">)</span>
            <span class="c1"># set redirect code to See Other unless redirecting to</span>
            <span class="c1"># the detail display for *this* item exactly</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">303</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="c1"># otherwise: (i.e., for journal articles), there is no meaningful</span>
        <span class="c1"># view to redirect to, so display a minimal page</span>
        <span class="c1"># (fall through to template display)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="InstanceURIView.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceURIView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;hide_placeholder&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;hide_nav&#39;</span><span class="p">:</span> <span class="kc">True</span>
        <span class="p">})</span></div></div>
        <span class="k">return</span> <span class="n">context</span>


<div class="viewcode-block" id="InstanceReferenceDetailView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceReferenceDetailView">[docs]</a><span class="k">class</span> <span class="nc">InstanceReferenceDetailView</span><span class="p">(</span><span class="n">InstanceDetailView</span><span class="p">):</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/detail/references.html&#39;</span>

<div class="viewcode-block" id="InstanceReferenceDetailView.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceReferenceDetailView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">InstanceReferenceDetailView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>\
            <span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="n">Reference</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">instance_slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">slug</span><span class="p">)</span>

        <span class="n">sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_by&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sort</span> <span class="o">==</span> <span class="s1">&#39;book_page&#39;</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">refs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;book_page_sort&#39;</span><span class="p">)</span>
            <span class="n">context</span><span class="p">[</span><span class="s1">&#39;order_by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;book_page&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="n">refs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;derridawork_page&#39;</span><span class="p">)</span>

        <span class="n">context</span><span class="p">[</span><span class="s1">&#39;references&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refs</span></div></div>
        <span class="k">return</span> <span class="n">context</span>


<div class="viewcode-block" id="InstanceListView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceListView">[docs]</a><span class="k">class</span> <span class="nc">InstanceListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="c1"># NOTE: haystack includes generic views, but they are not well documented</span>
    <span class="c1"># and don&#39;t seem to work quite right, so sticking with stock django</span>
    <span class="c1"># class-based views and forms.</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Instance</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">InstanceSearchForm</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/instance_list.html&#39;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="InstanceListView.get_queryset"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sqs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
        <span class="c1"># restrict to cited books</span>
        <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">item_type_exact</span><span class="o">=</span><span class="s1">&#39;Book&#39;</span><span class="p">,</span> <span class="n">cited_in</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="c1"># Note: using item_type_exact to avoid matching book section</span>

        <span class="c1"># initialize form with user search parameters and form defaults</span>
        <span class="c1"># preserve as QueryDict to get smart single item/list behavior</span>
        <span class="n">form_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># set default values</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set as list to avoid nested lists</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">form_opts</span><span class="o">.</span><span class="n">setlistdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form_opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">form_opts</span><span class="p">)</span>

        <span class="c1"># request facet counts and filter for solr</span>
        <span class="c1"># form handles the solr name for the fields</span>
        <span class="k">for</span> <span class="n">facet_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">:</span>
            <span class="n">field_values</span> <span class="o">=</span> <span class="n">form_opts</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">facet_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># if the field has a value</span>
            <span class="k">if</span> <span class="n">field_values</span><span class="p">:</span>
                <span class="c1"># narrow adds to fq but not q and creates a tag to use</span>
                <span class="c1"># in excluding later</span>
                <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span>
                    <span class="s1">&#39;{!tag=</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="s1">_exact:(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                    <span class="p">(</span>
                        <span class="n">facet_field</span><span class="p">,</span>
                        <span class="n">facet_field</span><span class="p">,</span>
                        <span class="s1">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">field_values</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="c1"># sort by alpha instead of solr default of count</span>
            <span class="c1"># facet adds to the list of generate facets but excludes</span>
            <span class="c1"># so that OR behavior exists for counts within a filter rather</span>
            <span class="c1"># than and</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="s1">&#39;{!ex=</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="s1">_exact&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">facet_field</span><span class="p">,</span> <span class="n">facet_field</span><span class="p">),</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="c1"># form shouldn&#39;t normally be invalid since no fields are</span>
        <span class="c1"># required, but cleaned data isn&#39;t available until we validate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback to defaults (i.e. sort only)</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">defaults</span>

        <span class="c1"># filter solr query based on search options</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">Clean</span><span class="p">(</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_annotated&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_annotated</span><span class="o">=</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;is_annotated&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_extant&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_extant</span><span class="o">=</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;is_extant&#39;</span><span class="p">])</span>


        <span class="c1"># request range facets</span>
        <span class="c1"># get max/min from database to specify range start &amp; end values</span>

        <span class="c1"># set the aggregate queries for this particular query and their</span>
        <span class="c1"># kwarg names as a dictionary</span>
        <span class="n">aggregate_queries</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;work_year_max&#39;</span><span class="p">:</span> <span class="n">Max</span><span class="p">(</span><span class="s1">&#39;work__year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;work_year_min&#39;</span><span class="p">:</span> <span class="n">Min</span><span class="p">(</span><span class="s1">&#39;work__year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;copyright_year_max&#39;</span><span class="p">:</span> <span class="n">Max</span><span class="p">(</span><span class="s1">&#39;copyright_year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;copyright_year_min&#39;</span><span class="p">:</span> <span class="n">Min</span><span class="p">(</span><span class="s1">&#39;copyright_year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;print_year_max&#39;</span><span class="p">:</span> <span class="n">Max</span><span class="p">(</span><span class="s1">&#39;print_date&#39;</span><span class="p">),</span>
            <span class="s1">&#39;print_year_min&#39;</span><span class="p">:</span> <span class="n">Min</span><span class="p">(</span><span class="s1">&#39;print_date&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># check for a namespaced _ranges variable in Django cache</span>
        <span class="c1"># return None if not found by default</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;instance_ranges&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="c1"># NOTE: restricting to cited books currently returns null for copyright</span>
            <span class="c1"># which breaks the logic here; get a larger range for now</span>
            <span class="c1"># ranges = Instance.objects.filter(is_extant=True, cited_in__isnull=False) \</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="n">Instance</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_extant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="o">**</span><span class="n">aggregate_queries</span><span class="p">)</span>
            <span class="c1"># pre-process datetime.date instances to get just</span>
            <span class="c1"># year as an integer</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
                    <span class="n">ranges</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">year</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;instance_ranges&#39;</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)</span>

        <span class="c1"># request range facets values and optionally filter ranges</span>
        <span class="c1"># on configured range facet fields</span>
        <span class="k">for</span> <span class="n">range_facet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">range_facets</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># range filter requested in search options</span>
            <span class="k">if</span> <span class="n">range_facet</span> <span class="ow">in</span> <span class="n">search_opts</span> <span class="ow">and</span> <span class="n">search_opts</span><span class="p">[</span><span class="n">range_facet</span><span class="p">]:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">search_opts</span><span class="p">[</span><span class="n">range_facet</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="c1"># could have both start and end or just one</span>
                <span class="c1"># NOTE: haystack includes a range field lookup, but</span>
                <span class="c1"># it converts numbers to strings, so this is easier</span>
                <span class="n">range_filter</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1"> TO </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
                <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">range_facet</span><span class="p">:</span> <span class="n">Raw</span><span class="p">(</span><span class="n">range_filter</span><span class="p">)})</span>

            <span class="c1"># current range filter becomes start/end if specified</span>
            <span class="n">range_opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="n">ranges</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_min&#39;</span> <span class="o">%</span> <span class="n">range_facet</span><span class="p">],</span>
                <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">if</span> <span class="n">end</span> <span class="k">else</span> <span class="n">ranges</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_max&#39;</span> <span class="o">%</span> <span class="n">range_facet</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="c1"># calculate gap based start and end &amp; desired number of slices</span>
            <span class="c1"># ideally, generate 15 slices; minimum gap size of 1</span>
            <span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">15.0</span><span class="p">))</span>
            <span class="c1"># restrict last range to *actual* maximum value</span>
            <span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;hardend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># request the range facet with the specified options</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="n">range_facet</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">range_opts</span><span class="p">)</span>

        <span class="c1"># sort should always be set</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;order_by&#39;</span><span class="p">]:</span>
            <span class="c1"># convert sort option to corresponding solr field</span>
            <span class="n">solr_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">solr_field</span><span class="p">(</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;order_by&#39;</span><span class="p">])</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">solr_sort</span><span class="p">)</span>

        <span class="c1"># store for retrieving facets in get context data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">sqs</span></div>
        <span class="k">return</span> <span class="n">sqs</span>

<div class="viewcode-block" id="InstanceListView.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.InstanceListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">InstanceListView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">facets</span> <span class="o">=</span> <span class="n">facet_sort_ignoreaccents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">facet_counts</span><span class="p">(),</span> <span class="s1">&#39;author&#39;</span><span class="p">)</span>
        <span class="c1"># update multi-choice fields based on facets in the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">set_choices_from_facets</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">))</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="n">facets</span><span class="p">,</span>   <span class="c1"># now includes ranges as facets.ranges</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
        <span class="p">})</span></div></div>
        <span class="k">return</span> <span class="n">context</span>


<div class="viewcode-block" id="ReferenceListView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceListView">[docs]</a><span class="k">class</span> <span class="nc">ReferenceListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="c1"># full reference list; eventually will have filter/sort options</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Reference</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ReferenceSearchForm</span>
    <span class="n">paginate_by</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/reference_list.html&#39;</span>
    <span class="n">form</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ReferenceListView.get_queryset"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceListView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sqs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>

        <span class="c1"># initialize form with user search parameters and form defaults</span>
        <span class="c1"># preserve as QueryDict to get smart single item/list behavior</span>
        <span class="n">form_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># set default values</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># set as list to avoid nested lists</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">form_opts</span><span class="o">.</span><span class="n">setlistdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">form_opts</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">form_opts</span><span class="p">)</span>

        <span class="c1"># add facet fields to filter query and tag for exclusion in generating</span>
        <span class="c1"># facets</span>

        <span class="c1"># form handles the solr name for the fields, but in the lookup below</span>
        <span class="c1"># if it&#39;s a mapped field, i.e. instance_author -&gt;</span>
        <span class="c1"># instance, then map for the field value lookup (but not for solr fq).</span>
        <span class="k">for</span> <span class="n">facet_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">facet_fields</span><span class="p">:</span>
            <span class="n">form_field</span> <span class="o">=</span> <span class="n">facet_field</span>
            <span class="k">if</span> <span class="n">facet_field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">solr_facet_fields</span><span class="p">:</span>
                <span class="n">form_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">solr_facet_fields</span><span class="p">[</span><span class="n">facet_field</span><span class="p">]</span>
            <span class="n">field_values</span> <span class="o">=</span> <span class="n">form_opts</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">form_field</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="c1"># if the field has a value</span>
            <span class="k">if</span> <span class="n">field_values</span><span class="p">:</span>
                <span class="c1"># narrow adds to fq but not q and creates a tag to use</span>
                <span class="c1"># in excluding later</span>
                <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span>
                    <span class="s1">&#39;{!tag=</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="s1">_exact:(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span>
                    <span class="p">(</span>
                        <span class="n">facet_field</span><span class="p">,</span>
                        <span class="n">facet_field</span><span class="p">,</span>
                        <span class="s1">&#39; OR &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">val</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">field_values</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="c1"># sort by alpha instead of solr default of count</span>
            <span class="c1"># facet adds to the list of generate facets but excludes</span>
            <span class="c1"># so that OR behavior exists for counts within a filter rather</span>
            <span class="c1"># than and</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="s1">&#39;{!ex=</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="s1">_exact&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">facet_field</span><span class="p">,</span> <span class="n">facet_field</span><span class="p">),</span> <span class="n">sort</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>

        <span class="c1"># request facet counts and filter for solr</span>
        <span class="c1"># form shouldn&#39;t normally be invalid since no fields are</span>
        <span class="c1"># required, but cleaned data isn&#39;t available until we validate</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># fallback to defaults (i.e. sort only)</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">defaults</span>

        <span class="c1"># filter solr query based on search options</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">Clean</span><span class="p">(</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_extant&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">instance_is_extant</span><span class="o">=</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;is_extant&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_annotated&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">instance_is_annotated</span><span class="o">=</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;is_annotated&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;corresponding_intervention&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">corresponding_intervention</span><span class="o">=</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;corresponding_intervention&#39;</span><span class="p">])</span>
        <span class="c1"># request range facets for References, adapated from logic</span>
        <span class="c1"># above for Instances</span>
        <span class="c1"># get max/min from database to specify range start &amp; end values</span>

        <span class="c1"># set the aggregate queries for this particular query and their</span>
        <span class="c1"># kwarg names as a dictionary</span>
        <span class="n">aggregate_queries</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;instance_work_year_max&#39;</span><span class="p">:</span> <span class="n">Max</span><span class="p">(</span><span class="s1">&#39;instance__work__year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;instance_work_year_min&#39;</span><span class="p">:</span> <span class="n">Min</span><span class="p">(</span><span class="s1">&#39;instance__work__year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;instance_copyright_year_max&#39;</span><span class="p">:</span> <span class="n">Max</span><span class="p">(</span><span class="s1">&#39;instance__copyright_year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;instance_copyright_year_min&#39;</span><span class="p">:</span> <span class="n">Min</span><span class="p">(</span><span class="s1">&#39;instance__copyright_year&#39;</span><span class="p">),</span>
            <span class="s1">&#39;instance_print_year_max&#39;</span><span class="p">:</span> <span class="n">Max</span><span class="p">(</span><span class="s1">&#39;instance__print_date&#39;</span><span class="p">),</span>
            <span class="s1">&#39;instance_print_year_min&#39;</span><span class="p">:</span> <span class="n">Min</span><span class="p">(</span><span class="s1">&#39;instance__print_date&#39;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># check for a namespaced _ranges variable in Django cache</span>
        <span class="c1"># return None if not found by default</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;reference_ranges&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="n">ranges</span> <span class="o">=</span> <span class="n">Reference</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">instance__is_extant</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> \
                <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="o">**</span><span class="n">aggregate_queries</span><span class="p">)</span>
            <span class="c1"># pre-process datetime.date instances to get just</span>
            <span class="c1"># year as an integer</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">ranges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
                    <span class="n">ranges</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">year</span>
            <span class="n">cache</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;reference_ranges&#39;</span><span class="p">,</span> <span class="n">ranges</span><span class="p">)</span>

        <span class="c1"># request range facets values and optionally filter ranges</span>
        <span class="c1"># on configured range facet fields</span>
        <span class="k">for</span> <span class="n">range_facet</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">range_facets</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># range filter requested in search options</span>
            <span class="k">if</span> <span class="n">range_facet</span> <span class="ow">in</span> <span class="n">search_opts</span> <span class="ow">and</span> <span class="n">search_opts</span><span class="p">[</span><span class="n">range_facet</span><span class="p">]:</span>
                <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">search_opts</span><span class="p">[</span><span class="n">range_facet</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                <span class="c1"># could have both start and end or just one</span>
                <span class="c1"># NOTE: haystack includes a range field lookup, but</span>
                <span class="c1"># it converts numbers to strings, so this is easier</span>
                <span class="n">range_filter</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1"> TO </span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">start</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">end</span> <span class="ow">or</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
                <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">range_facet</span><span class="p">:</span> <span class="n">Raw</span><span class="p">(</span><span class="n">range_filter</span><span class="p">)})</span>

            <span class="c1"># current range filter becomes start/end if specified</span>
            <span class="n">range_opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;start&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="k">if</span> <span class="n">start</span> <span class="k">else</span> <span class="n">ranges</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_min&#39;</span> <span class="o">%</span> <span class="n">range_facet</span><span class="p">],</span>
                <span class="s1">&#39;end&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">if</span> <span class="n">end</span> <span class="k">else</span> <span class="n">ranges</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_max&#39;</span> <span class="o">%</span> <span class="n">range_facet</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="c1"># calculate gap based start and end &amp; desired number of slices</span>
            <span class="c1"># ideally, generate 15 slices; minimum gap size of 1</span>
            <span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mf">15.0</span><span class="p">))</span>
            <span class="c1"># restrict last range to *actual* maximum value</span>
            <span class="n">range_opts</span><span class="p">[</span><span class="s1">&#39;hardend&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># request the range facet with the specified options</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">facet</span><span class="p">(</span><span class="n">range_facet</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">range_opts</span><span class="p">)</span>

        <span class="c1"># sort should always be set</span>
        <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;order_by&#39;</span><span class="p">]:</span>
            <span class="c1"># convert sort option to corresponding solr field</span>
            <span class="n">solr_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">solr_field</span><span class="p">(</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;order_by&#39;</span><span class="p">])</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">solr_sort</span><span class="p">)</span>

        <span class="c1"># store for accessing counts &amp; facets in context data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">sqs</span></div>
        <span class="k">return</span> <span class="n">sqs</span>

<div class="viewcode-block" id="ReferenceListView.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceListView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ReferenceListView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">facets</span> <span class="o">=</span> <span class="n">facet_sort_ignoreaccents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">facet_counts</span><span class="p">(),</span> <span class="s1">&#39;instance_author&#39;</span><span class="p">)</span>
        <span class="c1"># update multi-choice fields based on facets in the data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">set_choices_from_facets</span><span class="p">(</span><span class="n">facets</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fields&#39;</span><span class="p">))</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;facets&#39;</span><span class="p">:</span> <span class="n">facets</span><span class="p">,</span>
            <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="p">,</span>
        <span class="p">})</span></div></div>
        <span class="k">return</span> <span class="n">context</span>


<div class="viewcode-block" id="ReferenceHistogramView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceHistogramView">[docs]</a><span class="k">class</span> <span class="nc">ReferenceHistogramView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/reference_histogram.html&#39;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Reference</span>

<div class="viewcode-block" id="ReferenceHistogramView.get_queryset"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceHistogramView.get_queryset">[docs]</a>    <span class="k">def</span> <span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">refs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ReferenceHistogramView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="c1"># sort based on specified mode</span>
        <span class="c1"># NOTE: eventually this willl need to filter/segment</span>
        <span class="c1"># on derrida work, when we have more than one.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">refs</span><span class="o">.</span><span class="n">order_by_source_page</span><span class="p">()</span> \
                       <span class="o">.</span><span class="n">summary_values</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># including authors results in multiple entries</span>
            <span class="c1"># for multi-author works, so only include if needed</span>
            <span class="k">return</span> <span class="n">refs</span><span class="o">.</span><span class="n">order_by_author</span><span class="p">()</span> \</div>
                       <span class="o">.</span><span class="n">summary_values</span><span class="p">(</span><span class="n">include_author</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="ReferenceHistogramView.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceHistogramView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ReferenceHistogramView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">()</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;derrida_works&#39;</span><span class="p">:</span> <span class="n">DerridaWork</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="s1">&#39;derridawork_slug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;derridawork_slug&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;section&#39;</span><span class="p">:</span>
            <span class="c1"># get sections for the specified derrida work</span>
            <span class="n">sections</span> <span class="o">=</span> <span class="n">DerridaWorkSection</span><span class="o">.</span><span class="n">objects</span> \
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">derridawork__slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;derridawork_slug&#39;</span><span class="p">])</span>
            <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">],</span>
                <span class="s1">&#39;sections&#39;</span><span class="p">:</span> <span class="n">sections</span>
            <span class="p">})</span></div></div>
        <span class="k">return</span> <span class="n">context</span>


<div class="viewcode-block" id="ReferenceDetailView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceDetailView">[docs]</a><span class="k">class</span> <span class="nc">ReferenceDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="c1"># reference detail view for loading via ajax</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">Reference</span>
    <span class="n">ajax_template_name</span> <span class="o">=</span> <span class="s1">&#39;components/citation-list-item.html&#39;</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/reference_detail.html&#39;</span>

<div class="viewcode-block" id="ReferenceDetailView.get_template_names"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceDetailView.get_template_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># when queried via ajax, return partial html for pop-up display</span>
        <span class="c1"># in the visualization</span>
        <span class="c1"># (don&#39;t render the form or base template)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ajax_template_name</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">template_name</span>

<div class="viewcode-block" id="ReferenceDetailView.get_object"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ReferenceDetailView.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">queryset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">queryset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="c1"># NOTE: this is returning two results for some cases</span>
        <span class="c1"># (seems to be an error in the data; just return the first match)</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">derridawork_page</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">],</span>
            <span class="n">derridawork_pageloc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;pageloc&#39;</span><span class="p">],</span>
            <span class="n">derridawork__slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;derridawork_slug&#39;</span><span class="p">]</span></div></div>
            <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>


<div class="viewcode-block" id="SearchView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.SearchView">[docs]</a><span class="k">class</span> <span class="nc">SearchView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">SearchForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/multi_search.html&#39;</span>
    <span class="n">max_per_type</span> <span class="o">=</span> <span class="mi">3</span>

<div class="viewcode-block" id="SearchView.get"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.SearchView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Process form for :class:`SearchView`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># ignore page number when checking if options are set</span>
        <span class="n">form_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">form_opts</span><span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">form</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="p">(</span><span class="n">form_opts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">form_class</span><span class="o">.</span><span class="n">defaults</span><span class="p">)</span>
        <span class="c1"># if search on a single type is requested, forward to the</span>
        <span class="c1"># appropriate view</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
            <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;book&#39;</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;books:list&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;reference&#39;</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;books:reference-list&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;intervention&#39;</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;interventions:list&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;content_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;outwork&#39;</span><span class="p">:</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;outwork:list&#39;</span><span class="p">)</span>

                <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">?query=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">303</span>  <span class="c1"># see other</span>
                <span class="k">return</span> <span class="n">response</span>
</div>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">SearchView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="SearchView.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.SearchView.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Retrieve Solr queries for :class:`SearchView` context.&#39;&#39;&#39;</span>
        <span class="n">search_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="n">sqs</span> <span class="o">=</span> <span class="n">SearchQuerySet</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">]:</span>
            <span class="n">sqs</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">])</span>

        <span class="c1"># NOTE: Solr supports grouping results in a single search, but</span>
        <span class="c1"># haystack does not.  For now, query each content type separately.</span>

        <span class="n">instance_query</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="n">Instance</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">reference_query</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="n">Reference</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">intervention_query</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="n">Intervention</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">outwork_query</span> <span class="o">=</span> <span class="n">sqs</span><span class="o">.</span><span class="n">models</span><span class="p">(</span><span class="n">Outwork</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;query&#39;</span><span class="p">:</span> <span class="n">search_opts</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">],</span>
            <span class="s1">&#39;instance_list&#39;</span><span class="p">:</span> <span class="n">instance_query</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_per_type</span><span class="p">],</span>
            <span class="s1">&#39;instance_count&#39;</span><span class="p">:</span> <span class="n">instance_query</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s1">&#39;reference_list&#39;</span><span class="p">:</span> <span class="n">reference_query</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_per_type</span><span class="p">],</span>
            <span class="s1">&#39;reference_count&#39;</span><span class="p">:</span> <span class="n">reference_query</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s1">&#39;intervention_list&#39;</span><span class="p">:</span> <span class="n">intervention_query</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_per_type</span><span class="p">],</span>
            <span class="s1">&#39;intervention_count&#39;</span><span class="p">:</span> <span class="n">intervention_query</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s1">&#39;outwork_list&#39;</span><span class="p">:</span> <span class="n">outwork_query</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">max_per_type</span><span class="p">],</span>
            <span class="s1">&#39;outwork_count&#39;</span><span class="p">:</span> <span class="n">outwork_query</span><span class="o">.</span><span class="n">count</span><span class="p">()</span></div></div>
        <span class="p">}</span>


<div class="viewcode-block" id="CanvasDetail"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasDetail">[docs]</a><span class="k">class</span> <span class="nc">CanvasDetail</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Canvas</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;books/public_canvas_detail.html&#39;</span>

<div class="viewcode-block" id="CanvasDetail.get_object"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasDetail.get_object">[docs]</a>    <span class="k">def</span> <span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Limit canvas detail view to those with</span>
<span class="sd">        :class:`derrida.interventions.models.Intervention` objects associated.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">])</span>
        <span class="n">canvas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">images</span><span class="p">()</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">short_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;short_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

        <span class="c1"># only show canvas detail page for insertions, overview images,</span>
        <span class="c1"># and pages with documented interventions</span>
        <span class="k">if</span> <span class="n">canvas</span> <span class="ow">and</span> <span class="n">Instance</span><span class="o">.</span><span class="n">allow_canvas_detail</span><span class="p">(</span><span class="n">canvas</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">canvas</span>
        <span class="k">else</span><span class="p">:</span></div>
            <span class="k">raise</span> <span class="n">Http404</span>

<div class="viewcode-block" id="CanvasDetail.get_context_data"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasDetail.get_context_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set extra context for :class:`CanvasDetail` view.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">CanvasDetail</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># If there is a plain_text_url in info, use a Djiffy method to get the</span>
        <span class="c1"># text from Figgy and pass it to the view, default ocr_text to None</span>
        <span class="n">ocr_text</span> <span class="o">=</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Make sure we have a variable to test against in case of a connect error</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">plain_text_url</span><span class="p">:</span>
            <span class="c1"># get the text</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">get_iiif_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">plain_text_url</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ConnectionError</span><span class="p">:</span>
                <span class="c1"># log the stack trace using exception handler and</span>
                <span class="c1"># provide the url where the error happened to the log</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Connection error getting OCR text for </span><span class="si">%s</span><span class="s1">&#39;</span>
                                 <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">get_full_path</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">))</span>
            <span class="c1"># check that we got a valid response and set ocr_text if so.</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">ocr_text</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">text</span>
        <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;instance&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span>
            <span class="s1">&#39;canvas_suppressed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">suppress_all_images</span> <span class="ow">or</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">object</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">suppressed_images</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
            <span class="s1">&#39;ocr_text&#39;</span><span class="p">:</span> <span class="n">ocr_text</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;books.change_instance&#39;</span><span class="p">):</span>
            <span class="n">context</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;suppress_form&#39;</span><span class="p">:</span> <span class="n">SuppressImageForm</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">short_id</span><span class="p">}),</span>
            <span class="p">})</span></div></div>
        <span class="k">return</span> <span class="n">context</span>


<div class="viewcode-block" id="CanvasSuppress"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasSuppress">[docs]</a><span class="k">class</span> <span class="nc">CanvasSuppress</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Form view to process an admin request to suppress a single</span>
<span class="sd">    canvas image or all annotated pages from a volume.  Requires</span>
<span class="sd">    user to have change_instance permission.&#39;&#39;&#39;</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">SuppressImageForm</span>

    <span class="nd">@method_decorator</span><span class="p">(</span><span class="n">permission_required</span><span class="p">(</span><span class="s1">&#39;books.change_instance&#39;</span><span class="p">))</span>
    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">CanvasSuppress</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="CanvasSuppress.get"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasSuppress.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return 303 for suppressed canvas and redirect to detail view</span>
<span class="sd">        for :class:`derria.books.models.Instance`.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># no get display; redirect to book detail</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;books:detail&#39;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">]}))</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">303</span>  <span class="c1"># see other</span></div>
        <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="CanvasSuppress.form_valid"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasSuppress.form_valid">[docs]</a>    <span class="k">def</span> <span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Custom form validation for canvas surpress form.&#39;&#39;&#39;</span>
        <span class="c1"># process valid POSTed form data</span>
        <span class="n">formdata</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span>
        <span class="n">instance</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">])</span>

        <span class="c1"># suppress current page or all pages</span>
        <span class="k">if</span> <span class="n">formdata</span><span class="p">[</span><span class="s1">&#39;suppress&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;current&#39;</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digital_edition</span><span class="o">.</span><span class="n">canvases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">short_id</span><span class="o">=</span><span class="n">formdata</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">])</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">suppressed_images</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">canvas</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Canvas successfully suppressed.&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">suppress_all_images</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Successfully suppressed all annotated pages for this instance.&#39;</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Redirect to canvas detail view</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;books:canvas-detail&#39;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;short_id&#39;</span><span class="p">:</span> <span class="n">formdata</span><span class="p">[</span><span class="s1">&#39;canvas_id&#39;</span><span class="p">]}))</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">303</span>  <span class="c1"># see other</span></div></div>
        <span class="k">return</span> <span class="n">response</span>


<div class="viewcode-block" id="ProxyView"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ProxyView">[docs]</a><span class="k">class</span> <span class="nc">ProxyView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="c1"># ProxyView, modeled on Django&#39;s RedirectView</span>
    <span class="c1"># adapted from the Readux codebase (readux.books.views)</span>

<div class="viewcode-block" id="ProxyView.get"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ProxyView.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set headers for image requests to :class:`ProxyView`. Ensures</span>
<span class="sd">        HTTP cache headers are set.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proxy_url</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># use headers to allow browsers to cache downloaded copies</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;HTTP_IF_MODIFIED_SINCE&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTP_IF_UNMODIFIED_SINCE&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;HTTP_IF_MATCH&#39;</span><span class="p">,</span> <span class="s1">&#39;HTTP_IF_NONE_MATCH&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="p">:</span>
                <span class="n">headers</span><span class="p">[</span><span class="n">header</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;HTTP_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">META</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="n">remote_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="n">local_response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
        <span class="n">local_response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">remote_response</span><span class="o">.</span><span class="n">status_code</span>

        <span class="c1"># include response headers, except for server-specific items</span>
        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">remote_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;Keep-Alive&#39;</span><span class="p">,</span> <span class="s1">&#39;Link&#39;</span><span class="p">]:</span>
                             <span class="c1"># &#39;Access-Control-Allow-Origin&#39;, &#39;Link&#39;]:</span>
                <span class="c1"># NOTE: link header is valuable, but would</span>
                <span class="c1"># need to be made relative to current url</span>
                <span class="n">local_response</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># special case, for deep zoom (hack)</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;info&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">remote_response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="c1"># need to adjust the id to be relative to current url</span>
            <span class="c1"># this is a hack, patching in a proxy iiif interface at this url</span>
            <span class="n">data</span><span class="p">[</span><span class="s1">&#39;@id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">absolutize_url</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/info/&#39;</span><span class="p">,</span> <span class="s1">&#39;/iiif&#39;</span><span class="p">),</span>
                <span class="n">request</span><span class="p">)</span>

            <span class="n">local_response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># upate content-length for change in data</span>
            <span class="n">local_response</span><span class="p">[</span><span class="s1">&#39;content-length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">local_response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
            <span class="c1"># needed to allow external site (i.e. jekyll export)</span>
            <span class="c1"># to use deepzoom</span>
            <span class="n">local_response</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># include response content if any</span>
            <span class="n">local_response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">remote_response</span><span class="o">.</span><span class="n">content</span>
</div>
        <span class="k">return</span> <span class="n">local_response</span>

<div class="viewcode-block" id="ProxyView.head"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.ProxyView.head">[docs]</a>    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Proxy HTTP headers for image.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_proxy_url</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">remote_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">header</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">remote_response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">header</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Connection&#39;</span><span class="p">,</span> <span class="s1">&#39;Server&#39;</span><span class="p">,</span> <span class="s1">&#39;Keep-Alive&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">,</span> <span class="s1">&#39;Link&#39;</span><span class="p">]:</span>
                <span class="n">response</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div></div>
        <span class="k">return</span> <span class="n">response</span>


<div class="viewcode-block" id="CanvasImageByPageNumber"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasImageByPageNumber">[docs]</a><span class="k">class</span> <span class="nc">CanvasImageByPageNumber</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get a canvas image from an :class:`~derrida.books.models.Instance`</span>
<span class="sd">    by page number. Searches by page label, if no match is found returns</span>
<span class="sd">    the thumbnail for the Item if there is one.  404 if not found or</span>
<span class="sd">    the Instance has no digital edition associated.&#39;&#39;&#39;</span>
<div class="viewcode-block" id="CanvasImageByPageNumber.get"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasImageByPageNumber.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Return a canvas looked up by page number on GET request.&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">])</span>
        <span class="c1"># look up canvas for requested page number in this item</span>
        <span class="n">page</span> <span class="o">=</span> <span class="s1">&#39;p. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;page_num&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">digital_edition</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">images</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">label__exact</span><span class="o">=</span><span class="n">page</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="c1"># if page is not found, fallback to book cover</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas</span><span class="p">:</span>
                <span class="n">canvas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">digital_edition</span><span class="o">.</span><span class="n">thumbnail</span>

            <span class="c1"># if we have a canvas, redirect to thumbnail image view</span>
            <span class="k">if</span> <span class="n">canvas</span> <span class="ow">and</span> <span class="n">canvas</span><span class="o">.</span><span class="n">short_id</span><span class="p">:</span>
                <span class="n">url_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;slug&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">],</span>
                            <span class="s1">&#39;short_id&#39;</span><span class="p">:</span> <span class="n">canvas</span><span class="o">.</span><span class="n">short_id</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;smthumb&#39;</span><span class="p">}</span>
                <span class="c1"># only include @2x option when present</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">url_args</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
                <span class="n">canvas_url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;books:canvas-image&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">url_args</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">canvas_url</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="mi">303</span>  <span class="c1"># see other</span>
                <span class="k">return</span> <span class="n">response</span>

        <span class="c1"># 404 if no canvas was found</span></div></div>
        <span class="k">raise</span> <span class="n">Http404</span>


<div class="viewcode-block" id="CanvasImage"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasImage">[docs]</a><span class="k">class</span> <span class="nc">CanvasImage</span><span class="p">(</span><span class="n">ProxyView</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Local view for canvas images.  This proxies the</span>
<span class="sd">    configured IIIF image viewer in order to avoid exposing IIIF image</span>
<span class="sd">    urls for copyright content and to allow controlled access</span>
<span class="sd">    to restrict public viewable material to annotated pages,</span>
<span class="sd">    overview images, and insertions.&#39;&#39;&#39;</span>

    <span class="c1"># Minimum width o/ height is based on requested image size.</span>
    <span class="c1"># Thumbnail sizes are based on grid layout at maximum;</span>
    <span class="c1"># calculations based on max column width 52.5, max gutter width 30px</span>

    <span class="c1"># small thumbnail: 2 columns + 1 gutter = 135 (2x = 270)</span>
    <span class="n">SMALL_THUMBNAIL_WIDTH</span> <span class="o">=</span> <span class="mi">135</span>
    <span class="c1"># large thumbnail: 3 columns + 2 gutters ~=218 (2x = 435)</span>
    <span class="n">THUMBNAIL_WIDTH</span> <span class="o">=</span> <span class="mi">218</span>
    <span class="c1"># large image set by height for display in the browser page: 900/1800px</span>
    <span class="n">LARGE_HEIGHT</span> <span class="o">=</span> <span class="mi">900</span>

<div class="viewcode-block" id="CanvasImage.get_proxy_url"><a class="viewcode-back" href="../../../codedocs.html#derrida.books.views.CanvasImage.get_proxy_url">[docs]</a>    <span class="k">def</span> <span class="nf">get_proxy_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return a proxy url for client browsers to access IIIF images from.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">instance</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Instance</span><span class="p">,</span> <span class="n">slug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;slug&#39;</span><span class="p">])</span>

        <span class="c1"># if instance has no digital edition associated, there are</span>
        <span class="c1"># no images to be found</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">digital_edition</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="n">canvas_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;short_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">canvas_id</span> <span class="ow">and</span> <span class="n">canvas_id</span> <span class="o">!=</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">images</span><span class="p">()</span> \
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">short_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;short_id&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="c1"># if not found or default requested, use designated thumbnail</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">instance</span><span class="o">.</span><span class="n">digital_edition</span><span class="o">.</span><span class="n">thumbnail</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">canvas</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Http404</span>

        <span class="n">mode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;info&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;iiif&#39;</span><span class="p">:</span>
            <span class="c1"># also restrict iiif tiles based on large image permission</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">allow_canvas_large_image</span><span class="p">(</span><span class="n">canvas</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Http404</span>
            <span class="k">return</span> <span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;info.json&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>

        <span class="c1"># if large image is requested, make sure it is allowed before</span>
        <span class="c1"># any further processing</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span>
            <span class="c1"># only allow large images for insertions, overview images,</span>
            <span class="c1"># and pages with documented interventions</span>
            <span class="c1"># - also checks if an image has been suppressed</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">instance</span><span class="o">.</span><span class="n">allow_canvas_large_image</span><span class="p">(</span><span class="n">canvas</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">Http404</span>

        <span class="c1"># for specific sizes, request image info to determine available</span>
        <span class="c1"># preset sizes and use the closest size larger than what we need</span>
        <span class="c1"># (if the server supports it and provides sizes)</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;thumbnail&#39;</span><span class="p">,</span> <span class="s1">&#39;large&#39;</span><span class="p">,</span> <span class="s1">&#39;smthumb&#39;</span><span class="p">]:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
            <span class="n">available_sizes</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sizes&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">min_width</span> <span class="o">=</span> <span class="n">min_height</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;smthumb&#39;</span><span class="p">:</span>
            <span class="c1"># small thumbnail: 2 columns + 1 gutter = 135 (2x = 270)</span>
            <span class="n">min_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SMALL_THUMBNAIL_WIDTH</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;thumbnail&#39;</span><span class="p">:</span>
            <span class="c1"># large thumbnail: 3 columns + 2 gutters ~=218 (2x = 435)</span>
            <span class="n">min_width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">THUMBNAIL_WIDTH</span>
        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;large&#39;</span><span class="p">:</span>
            <span class="c1"># large image set by height for display in the browser</span>
            <span class="c1"># page: min-height: 900/1800px</span>
            <span class="n">min_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">LARGE_HEIGHT</span>

        <span class="c1"># if 2x is requested, double minimum size</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;@2x&#39;</span><span class="p">:</span>
            <span class="n">min_width</span> <span class="o">=</span> <span class="n">min_width</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">min_width</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">min_height</span> <span class="o">=</span> <span class="n">min_height</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">if</span> <span class="n">min_height</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># iterate through available image sizes and use the nearest size</span>
        <span class="c1"># larger than our minimum</span>
        <span class="k">for</span> <span class="n">size</span> <span class="ow">in</span> <span class="n">available_sizes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_width</span> <span class="ow">and</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_width</span><span class="p">:</span>
               <span class="k">return</span> <span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">**</span><span class="n">size</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_height</span> <span class="ow">and</span> <span class="n">size</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_height</span><span class="p">:</span>
               <span class="k">return</span> <span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="o">**</span><span class="n">size</span><span class="p">)</span>

        <span class="c1"># if no match was found or sizes are not available, use exact size</span>
        <span class="k">if</span> <span class="n">min_width</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">width</span><span class="o">=</span><span class="n">min_width</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">min_height</span><span class="p">:</span></div></div>
            <span class="k">return</span> <span class="n">canvas</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">min_height</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Derrida</a></h1>



<p class="blurb">Django web application for "Derrida's Margins" CDH project</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=Princeton-CDH&repo=derrida-django&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a href="https://travis-ci.org/Princeton-CDH/derrida-django">
    <img
        alt="https://secure.travis-ci.org/Princeton-CDH/derrida-django.svg?branch=master"
        src="https://secure.travis-ci.org/Princeton-CDH/derrida-django.svg?branch=master"
    />
</a>
</p>




    

<p>
<a href="https://codecov.io/github/Princeton-CDH/derrida-django">
    <img
    alt="https://codecov.io/github/Princeton-CDH/derrida-django/coverage.svg?branch=master"
    src="https://codecov.io/github/Princeton-CDH/derrida-django/coverage.svg?branch=master"
    />
</a>
</p>
<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../codedocs.html">Code Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../deploynotes.html">Deploy and Upgrade notes</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, CDH @ Princeton & Trustees of Princeton University.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>