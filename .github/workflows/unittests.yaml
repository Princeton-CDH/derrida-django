name: unit tests

on:
  push: # run on every push or PR to any branch
  # pull_request:

env:
  SOLR_CORE: derrida

jobs:
  python-unit:
    name: python unit tests
    runs-on: ubuntu-latest

    services:
      db:
        image: mariadb
        env:
          MYSQL_DATABASE: derrida
          MYSQL_ROOT_PASSWORD: derrida
        ports:
          - 3306:3306
      solr:
        image: solr:6.6
        ports:
          - 8983:8983
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          # This version is necessary for CI to run, despite the site being on python 3.5
          python-version: 3.6
      - uses: actions/setup-node@v2
        with:
          # This version is necessary for CI to run, despite the site being on node 8.16
          node-version: 10.16.3

      # Perform installations
      - run: pip install -r ci/ci-requirements.lock
      - run: npm install -g yarn
      - run: yarn install
      - run: yarn add postcss-cli postcss node-sass
      # - run: npm ci
      # HACK: Use different sass
      # - run: npm uninstall postcss-cli postcss node-sass
      # - run: npm install postcss-cli
      # - run: npm install postcss
      # - run: npm install -f node-sass
      # - run: pip install codecov

      # Setup local settings
      - run: cp ci/testsettings.py derrida/local_settings.py
      - run: python -c "import uuid; print('SECRET_KEY = \'%s\'' % uuid.uuid4())" >> derrida/local_settings.py

      # configure solr
      - name: Create solr core
        run: docker exec --user root ${{ job.services.solr.id }} /bin/bash -c "chown -R solr:solr /opt/solr/"
      - run: docker exec --user solr ${{ job.services.solr.id }} /bin/bash -c "/opt/solr/bin/solr create -c $SOLR_CORE -n basic_configs"

      # Configure site
      - name: Copy solr config
        run: docker cp ${{ job.services.solr.id }}:/opt/solr/server/solr/$SOLR_CORE/conf tmp-solr-config
      - name: run build_solr_schema to local schema
        run: python manage.py build_solr_schema --configure-directory=tmp-solr-config
      - name: upload configured schema
        run: docker cp tmp-solr-config ${{ job.services.solr.id }}:/opt/solr/server/solr/$SOLR_CORE/conf
      - name: Reload solr core
        run: curl http://localhost:8983/solr/admin/cores?action=RELOAD\&core=${{ SOLR_CORE }}

      - run: python manage.py migrate
      - run: python manage.py loaddata sample_work_data test_references
      - run: python manage.py rebuild_index --noinput # index in solr
      - run: python manage.py runserver --insecure & # run for pa11y, serve static content

      # Perform test
      - run: python -m pytest
      # - run: py.test --cov=derrida
