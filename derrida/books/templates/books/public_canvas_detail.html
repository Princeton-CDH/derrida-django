{% extends 'base.html' %}
{% load static %}

{% block page-subtitle %}{{ instance.work.primary_title }}{% if instance.work.authors.count == 1 %}, {{ instance.work.authors.first.lastname }}{% endif %} {% if instance.print_year or instance.copyright_year %}({% firstof instance.print_year instance.copyright_year %}{% if instance.copy %} - {{ instance.copy }}{% endif %}){% endif %} ‖ {{ canvas.label }} ‖ {% endblock %}
{% block nav-title %} Derrida's Library {% endblock %}

{% block header_class %}mdl-layout__header--transparent{% endblock %}

{% block body_class %}disable-coordinate-navigation{% endblock %}

{% block page-context-id %}book-image-gallery{% endblock %}

{% block page-js %}
<script src="{% static 'js//openseadragon/openseadragon.min.js' %}"></script>
<script type="text/javascript" charset="utf-8">
  document.addEventListener('DOMContentLoaded', function (){
    // basic seadragon configuration for deep zoom
      var viewer = OpenSeadragon({
        id: "deep-zoom",
        prefixUrl: "{% static 'js/openseadragon/images/' %}",
        tileSources: "{% url 'books:canvas-image' instance.slug canvas.short_id 'info' %}",
    });
    viewer.setFullPage = function( fullPage ) {
        var THIS = [{}]
        THIS.push($(this));
        var body = $("body")[0],
            bodyStyle = body.style,
            docStyle = document.documentElement.style,
            _this = this,
            nodes,
            i;

        //dont bother modifying the DOM if we are already in full page mode.
        if ( fullPage == this.isFullPage() ) {
            return this;
        }

        var fullPageEventArgs = {
            fullPage: fullPage,
            preventDefaultAction: false
        };
        /**
         * Raised when the viewer is about to change to/from full-page mode (see {@link OpenSeadragon.Viewer#setFullPage}).
         *
         * @event pre-full-page
         * @memberof OpenSeadragon.Viewer
         * @type {object}
         * @property {OpenSeadragon.Viewer} eventSource - A reference to the Viewer which raised the event.
         * @property {Boolean} fullPage - True if entering full-page mode, false if exiting full-page mode.
         * @property {Boolean} preventDefaultAction - Set to true to prevent full-page mode change. Default: false.
         * @property {?Object} userData - Arbitrary subscriber-defined object.
         */
        this.raiseEvent( 'pre-full-page', fullPageEventArgs );
        if ( fullPageEventArgs.preventDefaultAction ) {
            return this;
        }

        if ( fullPage ) {

            this.elementSize = $.getElementSize( this.element );
            this.pageScroll = $.getPageScroll();

            this.elementMargin = this.element.style.margin;
            this.element.style.margin = "0";
            this.elementPadding = this.element.style.padding;
            this.element.style.padding = "0";

            this.bodyMargin = bodyStyle.margin;
            this.docMargin = docStyle.margin;
            bodyStyle.margin = "0";
            docStyle.margin = "0";

            this.bodyPadding = bodyStyle.padding;
            this.docPadding = docStyle.padding;
            bodyStyle.padding = "0";
            docStyle.padding = "0";

            this.bodyWidth = bodyStyle.width;
            this.docWidth = docStyle.width;
            bodyStyle.width = "100%";
            docStyle.width = "100%";

            this.bodyHeight = bodyStyle.height;
            this.docHeight = docStyle.height;
            bodyStyle.height = "100%";
            docStyle.height = "100%";

            //when entering full screen on the ipad it wasnt sufficient to leave
            //the body intact as only only the top half of the screen would
            //respond to touch events on the canvas, while the bottom half treated
            //them as touch events on the document body.  Thus we remove and store
            //the bodies elements and replace them when we leave full screen.
            this.previousBody = [];
            THIS[ this.hash ].prevElementParent = this.element.parentNode;
            THIS[ this.hash ].prevNextSibling = this.element.nextSibling;
            THIS[ this.hash ].prevElementWidth = this.element.style.width;
            THIS[ this.hash ].prevElementHeight = this.element.style.height;
            nodes = body.childNodes.length;
            for ( i = 0; i < nodes; i++ ) {
                this.previousBody.push( body.childNodes[ 0 ] );
                body.removeChild( body.childNodes[ 0 ] );
            }

            //If we've got a toolbar, we need to enable the user to use css to
            //preserve it in fullpage mode
            if ( this.toolbar && this.toolbar.element ) {
                //save a reference to the parent so we can put it back
                //in the long run we need a better strategy
                this.toolbar.parentNode = this.toolbar.element.parentNode;
                this.toolbar.nextSibling = this.toolbar.element.nextSibling;
                body.appendChild( this.toolbar.element );

                //Make sure the user has some ability to style the toolbar based
                //on the mode
                $.addClass( this.toolbar.element, 'fullpage' );
            }

            $.addClass( this.element, 'fullpage' );
            body.appendChild( this.element );

            this.element.style.height = $.getWindowSize().y + 'px';
            this.element.style.width = $.getWindowSize().x + 'px';

            if ( this.toolbar && this.toolbar.element ) {
                this.element.style.height = (
                    $.getElementSize( this.element ).y - $.getElementSize( this.toolbar.element ).y
                ) + 'px';
            }

            THIS[ this.hash ].fullPage = true;

            // mouse will be inside container now
            $(this).trigger( viewer.onContainerEnter );

        } else {

            this.element.style.margin = this.elementMargin;
            this.element.style.padding = this.elementPadding;

            bodyStyle.margin = this.bodyMargin;
            docStyle.margin = this.docMargin;

            bodyStyle.padding = this.bodyPadding;
            docStyle.padding = this.docPadding;

            bodyStyle.width = this.bodyWidth;
            docStyle.width = this.docWidth;

            bodyStyle.height = this.bodyHeight;
            docStyle.height = this.docHeight;

            body.removeChild( this.element );
            nodes = this.previousBody.length;
            for ( i = 0; i < nodes; i++ ) {
                body.appendChild( this.previousBody.shift() );
            }

            $.removeClass( this.element, 'fullpage' );
            THIS[ this.hash ].prevElementParent.insertBefore(
                this.element,
                THIS[ this.hash ].prevNextSibling
            );

            //If we've got a toolbar, we need to enable the user to use css to
            //reset it to its original state
            if ( this.toolbar && this.toolbar.element ) {
                body.removeChild( this.toolbar.element );

                //Make sure the user has some ability to style the toolbar based
                //on the mode
                $.removeClass( this.toolbar.element, 'fullpage' );

                this.toolbar.parentNode.insertBefore(
                    this.toolbar.element,
                    this.toolbar.nextSibling
                );
                delete this.toolbar.parentNode;
                delete this.toolbar.nextSibling;
            }

            this.element.style.width = THIS[ this.hash ].prevElementWidth;
            this.element.style.height = THIS[ this.hash ].prevElementHeight;

            // After exiting fullPage or fullScreen, it can take some time
            // before the browser can actually set the scroll.
            var restoreScrollCounter = 0;
            var restoreScroll = function() {
                $.setPageScroll( _this.pageScroll );
                var pageScroll = $.getPageScroll();
                restoreScrollCounter++;
                if (restoreScrollCounter < 10 &&
                    (pageScroll.x !== _this.pageScroll.x ||
                    pageScroll.y !== _this.pageScroll.y)) {
                    $.requestAnimationFrame( restoreScroll );
                }
            };
            $.requestAnimationFrame( restoreScroll );

            THIS[ this.hash ].fullPage = false;

            // mouse will likely be outside now
            $.delegate( this, onContainerExit )( { } );

        }

        if ( this.navigator && this.viewport ) {
            this.navigator.update( this.viewport );
        }

        /**
         * Raised when the viewer has changed to/from full-page mode (see {@link OpenSeadragon.Viewer#setFullPage}).
         *
         * @event full-page
         * @memberof OpenSeadragon.Viewer
         * @type {object}
         * @property {OpenSeadragon.Viewer} eventSource - A reference to the Viewer which raised the event.
         * @property {Boolean} fullPage - True if changed to full-page mode, false if exited full-page mode.
         * @property {?Object} userData - Arbitrary subscriber-defined object.
         */
        this.raiseEvent( 'full-page', { fullPage: fullPage } );

        return this;
    }

  });
</script>

<script>
  $(function () {
    function htmlDecode(input) {
      var doc = new DOMParser().parseFromString(input, "text/html");
      return doc.documentElement.textContent;
    }

    function parseJSONFromHtml(input) {
      return JSON.parse(htmlDecode(input).replace(/\'/g, '\"'))
    }

    function calcRelativePosition(percentVal, rel) {
      return (parseFloat(percentVal)/100) * rel + "px"
    }

    var $annotationSection = $(".annotation-selections"),
        $deepZoom = $(".deep-zoom-component"),
        $img = $(".gallery-image-view__img"),
        imgH = parseFloat($img.height()),
        imgW = parseFloat($img.width()),
        zones = [];
    {# image selection zones #}
    {% for intervention in canvas.intervention_set.all %}
    {# provides x,y offset and width,height in percentages #}
      var data = "{{ intervention.extra_data.image_selection }}";
      zones.push(parseJSONFromHtml(data));
    {% endfor %}

    var drawAttempts = 0;
    function drawZones() {
      // if the image is not yet drawn, attempt to redraw zones
      if (imgH === 0) {
        // limit attmpts to draw zones
        if (drawAttempts > 6) {
          console.log("Failed to calculate and draw annotation areas");
          return;
        }
        imgH = parseFloat($img.height());
        imgW = parseFloat($img.width());
        drawAttempts++;
        setTimeout(drawZones, 500);
        return;
      }

      var zoneDivs = [];
      $.each(zones, function(index, zone) {
        var zoneCSS = {
            height: calcRelativePosition(zone.h, imgH),
            width: calcRelativePosition(zone.w, imgW),
            top: calcRelativePosition(zone.y, imgH),
            left: calcRelativePosition(zone.x, imgW)
          }
        var $zone = $("<div/>").addClass("zone").css(zoneCSS);
        zoneDivs.push($zone);
      });

      if (zoneDivs.length > 0) {
        $annotationSection.css({
          height: $deepZoom.height(),
          width: $deepZoom.width()
        }).append(zoneDivs);
        setTimeout(function() {
          $annotationSection.addClass("has-zones-added");
        }, 100)
      }
      return;
    }

    drawZones();

    $(".gallery-image-view__nav .mdl-switch__label").on("click", function(e) {
      var $this = $(this),
          $input = $this.find(".mdl-switch__input"),
          $switch = $this.find(".mdl-switch"),
          $sibling = $this.siblings().first().find(".mdl-switch"),
          $siblingInput = $sibling.find("input");
          value = $switch.hasClass("is-checked") ? $siblingInput.val() : $input.val();

      function toggleViews() {
        var $annotationSwitch = $("#annotations-switch"),
            $zoomSwitch = $("#zoom-switch"),
            $annotationCards = $(".annotation-cards");
        if (value === "annotations") {
          $annotationSection.removeClass("is-hidden");
          $annotationCards.removeClass("is-hidden");
          $deepZoom.addClass("is-hidden");

          $zoomSwitch.removeClass("is-checked");
          $annotationSwitch.addClass("is-checked");

        } else if (value === "zoom") {
          $annotationSection.addClass("is-hidden");
          $annotationCards.addClass("is-hidden");
          $deepZoom.removeClass("is-hidden");

          $annotationSwitch.removeClass("is-checked");
          $zoomSwitch.addClass("is-checked");
        } else {
          return false;
        }
      }

      setTimeout(toggleViews, 100);
    });

    var $toggle = $(".page-header__toggle"),
        $sideBar = $(".gallery-image-view__header");
    $toggle.on("click", function(e) {
      e.preventDefault();
      var $this = $(this);
      if ($this.hasClass("is-active")) {
        $sideBar.addClass("is-hidden");
        $this.removeClass("is-active");
      } else {
        $sideBar.removeClass("is-hidden");
        $this.addClass("is-active");
      }
    });

    function selectAnnotationCard($card) {
      var $this = $card,
          $zones = $annotationSelections.find(".zone"),
          idx = $(".collection__item").index($this),
          $selectedZone = $($zones[idx]);

      if (! $this.hasClass("is-selected")) {
        $this.siblings(".is-selected").removeClass("is-selected");
        $this.addClass("is-selected");

        $zones.removeClass("is-selected");
        $selectedZone.addClass("is-selected");
      }
    }

    function updateHashWithCardReference(referenceId) {
      window.location.hash = "#annotations/" + referenceId;
    }

    var $annotationCards = $(".annotation-cards .collection__item"),
        $annotationSelections = $(".annotation-selections");
    $annotationCards.on("click", function() {
      var $this = $(this);
      selectAnnotationCard($this);
      updateHashWithCardReference($this.data("refId"));
    });

    var $annotationList = $(".annotation-list");
    $annotationSelections.on("click", ".zone", function() {
      var $this = $(this),
          $zones = $annotationSelections.find(".zone"),
          idx = $zones.index($this),
          $selectedCard = $($annotationCards[idx]);
      if (! $this.hasClass("is-selected")) {
        // Add the highlight class to card
        $annotationCards.removeClass("is-selected");
        $selectedCard.addClass("is-selected");

        // Scroll annotation list so the selected card is in view.
        var top = $selectedCard.position().top;
        $annotationList.animate({ scrollTop: top });

        // Add the highlight class to zone
        $zones.removeClass("is-selected");
        $this.addClass("is-selected");

        // update hash
        updateHashWithCardReference($selectedCard.data("refId"));
      }
    });

    if (window.location.hash.indexOf("#annotations/") !== -1) {
      var annotationId = window.location.hash.split("/")[1];
      var $selected = $(".annotation-cards .collection__item[data-ref-id=" + annotationId + "]");
      if ($selected.length === 1) {
        selectAnnotationCard($selected);
      }
    }
  });
</script>
{% endblock %}

{% block content %}
  <header class="page-header page-header--link">
    <div class="container">
      <a class="page-header__toggle is-active"><img class="icon" src="{% static 'img/icons/Expand.svg' %}" /></a>
      <h1 class="page-header__heading"><a class="page-header__link" href="{% url 'books:detail-gallery' instance.slug %}"><span class="arrow_icon">⟵</span> Book Image Gallery</a></h1>

      <nav class="gallery-image-view__nav">
        <label class="mdl-switch__label mdl-switch__label--right">Display Annotations
          <span class="mdl-switch mdl-switch--right mdl-js-switch" id="annotations-switch">
            <input type="checkbox" name="view" value="annotations" checked="checked" class="mdl-switch__input" />
          </span>
        </label>

        <label class="mdl-switch__label mdl-switch__label--right">Turn on Deep Zoom
          <span class="mdl-switch mdl-switch--right mdl-js-switch" id="zoom-switch">
            <input type="checkbox" name="view" value="zoom" class="mdl-switch__input" />
          </span>
        </label>
      </nav>
    </div>
  </header>

  <article class="gallery-image-view">
    <header class="gallery-image-view__header">
      {# brief title information (copied from book-header) #}
      {% with book=instance %}
      <h1 class="item-title">{{ book.work.primary_title }}</h1>
      <p class="item-author">
        {% for author in book.work.authors.all %}
          {% if not forloop.last %}
            {{ author.authorized_name }};
          {% else %}
            {{ author.authorized_name }}
          {% endif %}
        {% endfor %}
      </p>
      <p class="item-term__value">{{ book.copyright_year }}{% if book.copy %} - {{ book.copy }}{% endif %}</p>
      {% endwith %}

      {# locations where cited by Derrida #}
      {# using corresponding references, since that is the only reliable way to identify #}
      {% if canvas.reference_set.all %}
        <h3 class="gallery-image-view__list-title">Cited in <span class="book-chapter-title">{{ canvas.reference_set.all.0.derridawork }}</span></h3>
        {% for reference in canvas.reference_set.all %}
          <span class="gallery-image-view__list-item">p.{{ reference.derridawork_page }}</span>
        {% endfor %}
        <hr class="gallery-image-view__list-end" />
      {% endif %}

      {# pages in this volume - navigation list #}

      {# overview images #}
      {% if instance.overview_images %}
        <h3 class="gallery-image-view__list-title--bold">Overview Images</h3>
        {% for ov_canvas in instance.overview_images %}
          <a class="gallery-image-view__list-item" href="{% url 'books:canvas-detail' instance.slug ov_canvas.short_id %}">
            {{ ov_canvas.label }}
          </a>
        {% endfor %}
        <hr class="gallery-image-view__list-end" />
      {% endif %}

      {% if instance.annotated_pages %}
        <h3 class="gallery-image-view__list-title--bold">Annotated pages</h3>
        {% for anno_canvas in instance.annotated_pages %}
          <a class="gallery-image-view__list-item" href="{% url 'books:canvas-detail' instance.slug anno_canvas.short_id %}">
            {{ anno_canvas.label }}
          </a>
        {% endfor %}
        <hr class="gallery-image-view__list-end" />
      {% endif %}

       {% if instance.insertion_images %}
         <h3 class="gallery-image-view__list-title--bold">Insertions</h3>
         {% for ins_canvas in instance.insertion_images %}
          <a class="gallery-image-view__list-item" href="{% url 'books:canvas-detail' instance.slug ins_canvas.short_id %}">
            {{ ins_canvas.label }}
          </a>
        {% endfor %}
        <hr class="gallery-image-view__list-end" />
      {% endif %}

      {% if suppress_form and perms.books.change_instance %}
      <section class="gallery-image-view__form">
        <h3 class="gallery-image-view__list-title--bold">Admin Actions</h3>
        {# admin form - suppress current page image or all annotated page images for this volume #}
        {# display if suppress form is present and user has permission to change book instance #}
        {% if instance.suppress_all_images %}
          <p>All annotated page images in this volume are suppressed.</p>
        {% elif canvas_suppressed %}
          <p>This page image is suppressed.</p>
        {% else %}
          <form class="suppress-form" method="POST" action="{% url 'books:suppress-canvas' instance.slug %}">
            {% csrf_token %}
            Suppress {{ suppress_form.suppress }}
            {{ suppress_form.canvas_id }}
            <input type="submit"/>
          </form>
        {% endif %}
      </section>
      {% endif %}
    </header>

    <article class="gallery-image-view__container">
      {% comment %}
      NOTE: if canvas_suppressed is true, access to page image has been restricted
      by an admin due to a copyright holder take-down request.
      Display a placeholder for the image, and show all other content.
      {% endcomment %}

      <section class="deep-zoom-component is-hidden">
        {# deep zoom #}
        <div id="deep-zoom"></div>
      </section>

      <div class="annotation-selections">
        {# large size image #}
        <img class="gallery-image-view__img" src="{% url 'books:canvas-image' instance.slug canvas.short_id 'large' %}" />
      </div>

      <section class="collection annotation-cards annotation-list">
        {% for intervention in canvas.intervention_set.all %}
          {% include 'components/intervention-card.html' %}
        {% endfor %}
      </section>
    </article>
    <footer class="gallery-image-view__footer">
      {# for now, only supports rightsstatments.org licenses (should work for PUL content) #}
      {% if instance.digital_edition.license %}
        <a href="{{ instance.digital_edition.license }}">
          <img class="img" src="{% static 'img/rightsstatements_org/' %}{{ instance.digital_edition.rights_statement_id }}.svg" />
        </a>
      {% endif %}

      {# logo for IIIF provider of digitized item #}
      <img class="img" src="{{ instance.digital_edition.logo }}"/>
    </footer>
  </article>
{% endblock %}

{# disable page footer #}
{% block page_footer %}{% endblock %}
